<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/dist/styles.css" />
    <title>Rivals DB</title>
  </head>
  <body>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/1.13/auth0-spa-js.production.js"></script>
    <script src="/dist/elm.js"></script>
    <script>
      function configureClient() {
        const config = {
          domain: "rivalsdb.eu.auth0.com",
          client_id: "jfoDbFRgDspBrj1h9NXY9RUgXIwfKHUQ",
        };
        return createAuth0Client(config);
      }

      function fetchCards() {
        return fetch("/cards.json").then((res) => res.json());
      }

      async function handleAuthcallback(auth0) {
        const query = window.location.search;
        if (query.includes("code=") && query.includes("state=")) {
          await auth0.handleRedirectCallback();
        }
        window.history.replaceState({}, document.title, "/");
      }

      Promise.all([fetchCards(), configureClient()]).then(
        async ([cards, auth0]) => {
          await handleAuthcallback(auth0);

          const app = Elm.Main.init({ flags: cards });

          app.ports.initiateLogin.subscribe((redirectUri) => {
            auth0.loginWithRedirect({ redirect_uri: window.location.origin });
          });
          app.ports.signOut.subscribe((redirectUri) => {
            auth0.logout({ returnTo: window.location.origin });
          });

          const isAuthenticated = await auth0.isAuthenticated();
          if (isAuthenticated) {
            const [token, user] = await Promise.all([
              auth0.getTokenSilently(),
              auth0.getUser(),
            ]);

            app.ports.signInReceiver.send({ token, user });
          }
        }
      );
    </script>
  </body>
</html>
